/*
 * Nudr_DataRepository API OpenAPI file
 *
 * Unified Data Repository Service
 *
 * API version: 1.0.0
 * Generated by: OpenAPI Generator (https://openapi-generator.tech)
 */

package DataRepository_test

import (
	"context"
	"github.com/davecgh/go-spew/spew"
	"free5gc/lib/openapi/common"
	"free5gc/lib/openapi/models"
	"net/http"
	"strings"
	"testing"
)

// AMFSubscriptions - Create, Query(Get) Update and Remove
func TestCreateGetModifyRemoveAMFSubscriptions(t *testing.T) {
	runTestServer(t)

	// Set client and set url
	client := setTestClient(t)

	var eeSubscription = models.EeSubscription{
		CallbackReference: "http://127.0.0.1/callback",
		MonitoringConfigurations: map[string]models.MonitoringConfiguration{
			"123": {
				EventType: models.EventType_LOSS_OF_CONNECTIVITY,
			},
		},
	}
	var amfSubscriptionInfoArray = []models.AmfSubscriptionInfo{
		{
			AmfInstanceId:                 "046b6c7f-0b8a-43b9-b35d-6489e6daee91",
			SubscriptionId:                "http://127.0.0.1/callback/amfinfo",
			SubsChangeNotifyCorrelationId: "subsChangeNotifyCorrelationId",
		},
	}

	ueId := "imsi-208930123456789"
	var subsUri string
	var subsId string
	_ = subsId

	// Testing error USER_NOT_FOUND for Create AMFSubscriptions
	{
		res, err := client.CreateAMFSubscriptionInfoDocumentApi.CreateAMFSubscriptions(context.TODO(), ueId, "1", amfSubscriptionInfoArray)
		if err != nil {
			spew.Dump(err.(common.GenericOpenAPIError).Model())
		}

		if status := res.StatusCode; status != http.StatusNotFound {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusNotFound)
		}
	}

	// Create eeSubscription
	{
		_, res, err := client.EventExposureSubscriptionsCollectionApi.CreateEeSubscriptions(context.TODO(), ueId, eeSubscription)
		if err != nil {
			t.Fatalf(err.Error())
		}

		if status := res.StatusCode; status != http.StatusCreated {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusCreated)
		}

		subsUri = res.Header.Get("Location")
		spew.Printf("[subsUri_Header_Location] %s\n", subsUri)
		subsId = subsUri[strings.LastIndex(subsUri, "/")+1:]
		spew.Printf("[subsId] %s\n", subsId)
	}

	// Testing error SUBSCRIPTION_NOT_FOUND for Create AMFSubscriptions
	{
		res, err := client.CreateAMFSubscriptionInfoDocumentApi.CreateAMFSubscriptions(context.TODO(), ueId, "999", amfSubscriptionInfoArray)
		if err != nil {
			spew.Dump(err.(common.GenericOpenAPIError).Model())
		}

		if status := res.StatusCode; status != http.StatusNotFound {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusNotFound)
		}
	}

	// Create AMFSubscriptions
	{
		res, err := client.CreateAMFSubscriptionInfoDocumentApi.CreateAMFSubscriptions(context.TODO(), ueId, subsId, amfSubscriptionInfoArray)
		if err != nil {
			t.Fatalf(err.Error())
		}

		if status := res.StatusCode; status != http.StatusNoContent {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusNoContent)
		}
	}

	// Query AMFSubscriptions
	{
		amfSubscriptionInfoArray, res, err := client.QueryAMFSubscriptionInfoDocumentApi.GetAmfSubscriptionInfo(context.TODO(), ueId, subsId)
		if err != nil {
			t.Fatalf(err.Error())
		}

		if status := res.StatusCode; status != http.StatusOK {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusOK)
		}

		spew.Dump(amfSubscriptionInfoArray)
	}

	var amfSubscriptionInfoPatchItem = []models.PatchItem{
		{
			Op:    models.PatchOperation_REPLACE,
			Path:  "/0/subscriptionId",
			Value: "http://127.0.0.1/callback/amfinfo_2",
		},
	}

	// Update AMFSubscriptions
	{
		res, err := client.AmfSubscriptionInfoDocumentApi.ModifyAmfSubscriptionInfo(context.TODO(), ueId, subsId, amfSubscriptionInfoPatchItem)
		if err != nil {
			t.Fatalf(err.Error())
		}

		if status := res.StatusCode; status != http.StatusNoContent {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusNoContent)
		}
	}

	// Query AMFSubscriptions
	{
		amfSubscriptionInfoArray, res, err := client.QueryAMFSubscriptionInfoDocumentApi.GetAmfSubscriptionInfo(context.TODO(), ueId, subsId)
		if err != nil {
			t.Fatalf(err.Error())
		}

		if status := res.StatusCode; status != http.StatusOK {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusOK)
		}

		spew.Dump(amfSubscriptionInfoArray)
	}

	// Delete AMFSubscriptions
	{
		res, err := client.EventAMFSubscriptionInfoDocumentApi.RemoveAmfSubscriptionsInfo(context.TODO(), ueId, subsId)
		if err != nil {
			t.Fatalf(err.Error())
		}

		if status := res.StatusCode; status != http.StatusNoContent {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusNoContent)
		}
	}

	// Query AMFSubscriptions
	{
		amfSubscriptionInfoArray, res, err := client.QueryAMFSubscriptionInfoDocumentApi.GetAmfSubscriptionInfo(context.TODO(), ueId, subsId)
		if err != nil {
			spew.Dump(err.(common.GenericOpenAPIError).Model())
		}

		if status := res.StatusCode; status != http.StatusNotFound {
			t.Errorf("handler returned wrong status code: got %v want %v",
				status, http.StatusNotFound)
		}
		spew.Dump(amfSubscriptionInfoArray)
	}

}
